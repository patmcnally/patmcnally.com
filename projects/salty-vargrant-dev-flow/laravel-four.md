# Salty Vagrant to Salty Suit &amp; Tie: Laravel Edition

**A Journey for both Dev and Ops**

Laravel Application with Vagrant controlling VirtualBox VMs running Ubuntu
12.04 LTS 32-bit running provisoned by Salt. Furthermore using those same Salt
States to provision a new production deployment.

While this HowTo is built around a Laravel project, the tools and workflow
demonstrated here generalize to any PHP project.  If you're not familiar with
the Laravel framework don't be discouraged. We're going to start with a
pre-built application and focus on building a virtual machine based
development environment, then demonstrate provisioning and deploying the
application in production.


## Getting the Example App

I've cobbled together a single resource Twitter clone in the Laravel framework
which lives on github as [salty-vagrant-laravel-app][laravel-app-repo]. However
we're going to refer to it more fondly as __emperor-norton-app__.  (See
[Emperor Norton](http://en.wikipedia.org/wiki/Emperor_Norton))

    $ git clone http://github.com/patmcnally/salty-vagrant-laravel emperor-norton-app
    $ cd emperor-norton-app
    $ git checkout bare-app

We'll install Vagrant into this application, add some plugins, then link in and
modify a set of Salt States for provisioning.


## Example App

To build your own __emperor_norton_app__

    1) Install Composer ([See Laravel Docs]:(http://laravel.com/docs/installation#install-composer))
    2) Install Laravel / Create Project ([See Laravel Docs]:(http://laravel.com/docs/installation#install-laravel))
    3) Create a git repository in the new project.
    4) Add /app/config/database.php to .gitignore. Then copy /app/config/database.php to /app/config/database-example.php.
       This is a per-machine config file and we don't want anyone saving database passwords into their repositories.
    5) Install Laravel 4 Generators package. ([See Instructions]:(https://github.com/JeffreyWay/Laravel-4-Generators))
    6) `php artisan generate:scaffold tweet --fields="author:string, body:text"`
    7) Modify /app/database/seeds/TweetsTableSeeder so the system can start with some tweets.
    8) Edit /app/views/hello.php to link to the tweets.index route.


## Vagrant and VirtualBox

Core to this workflow is the ability to run virtual machines that are near
identical matches to the production environment our application will be running
in. This allows us to develop on Linux for Linux while really on a Mac.  We'll
be using [VirtualBox][virtual-box-link] to run our virtual machines and
[Vagrant][vagrant-link] will be used to configure and kick off our Salt based
provisioning.

You'll need to download and install the latest versions of both [VirtualBox][virtual-box-downloads] and
[Vagrant][vagrant-download].

__Note:__ At the time of writing there is an issue with the latest versions of Vagrant
and VirtualBox playing well together. If you're using Vagrant 1.2.2 and VirtualBox 4.2.14
you need to use [enthayer](https://github.com/mitchellh/vagrant/issues/1850#issuecomment-20149984)'s
workaround. I'll have you do this in a moment.

With VirtualBox and Vagrant installed we're ready to setup Vagrant in our project.

    $ cd emperor-norton-app
    $ vagrant init precise32 http://files.vagrantup.com/precise32.box

This will create a `Vagrantfile` which specifies how Vagrant should spin up new
VMs for this project. At this point you could `vagrant up` and get a plain jane
Ubuntu 12.04 LTS virtual machine, easily accessed with `vagrant ssh`. Feel free
to do so now, then join us for adding some vagrant plugins then provisioning
the box with Salt for our Laravel application.


## Install Useful Vagrant Plugins

If you think you might be creating and destroying your virtual machines often you should install
the [vagrant-cachier][vagrant-cachier-link] for Vagrant. This will "share a common package cache among
similar VM instances" enabling apt-get to find packages in that shared cache instead of dowloading
apache everytime a new precise32 VM is brought up.

    $ vagrant plugin install vagrant-cachier

To simplify the process of accessing sites hosted by your guest machines use
[vagrant-hostsupdater][vagrant-hostsupdater-link] to automatically add an entry
in the host computer's `/etc/hosts` file for the ip and hostname configured
in the `Vagrantfile`

    $ vagrant plugin install vagrant-hostsupdater


## Salty Vagrant

Most crucial to this project is the [salty-vagrant][salty-vagrant-link] plugin
for Vagrant. It allows us to use the ridculously awesome Salt State for
configuration managment of both development and production. Install it now
with:

    $ vagrant plugin install vagrant-salt


## Configure Vagrant for Salty Vagrant and Others

You can either replace the `Vagrantfile` generated by Vagrant with a [complete
replacement][laravel-app-vagrantfile] or make the following changes by hand.

Between the line `Vagrant.configure("2") do |config|` and the very last line
`end` make the following changes

Add lines for configuring the network. Note we're using a role based naming
scheme for hostsname, and adding aliases so that the hostsupdater plugin can point
the DNS appropriately for the dev URL of the application we're building.

    config.vm.network :private_network, ip: "192.168.33.10"
    config.vm.hostname = "laravel-host-01.vm.dev"
    config.hostsupdater.aliases = ["emperor-norton-app.dev"]
    config.vm.network :forwarded_port, guest: 80, host: 8080

Add following to sync the folder we use to store the Salt file roots.

    config.vm.synced_folder "salt/roots/", "/srv/"

Followed by the block to configure salt.

    config.vm.provision :salt do |salt|
      salt.minion_config = "salt/minion"
      salt.run_highstate = true
    end

If you're using vagrant-cachier finally add the line:

    config.cache.auto_detect = true

## Configuration Managment with Salt

Salt, more precisesly, it's configuration managment system Salt States, enables
us to define the state of a system in a directory structure of simple YAML
files with the extension .sls (__S__a__L__t __S__tate file). In addition we can
also intermingle the files that need to be directly copied over or used to
modify existing files on the machine being configured. For example a vhost file
for apache, or an action config for fail2ban.

In a large deployment this directory structure is traditional stored on a
master machine under /srv/salt for the Salt State Tree and /srv/pillar for the
Salt Pillar Tree. New machines are called minions, each is bootstrapped by to a 
minimal configuration by a script and then connect to the master. They are then
configured to match the state as defined by the two trees. Salt can also
be run in 'masterless' mode, allowing a minion to be created directly from
a copy of the Salt State Tree.

With the understanding that our system's configuration can be defined in a set
of flat files in nested directories the question becomes is then how do we
store these?

One option is to have an invidual project be responsible for storing a complete
copy the state tree needed to host it. In this case the Salt State Tree and
Salt Pillar Trees can be directly built out directly in the root of your project's 
directory under /salt/roots/salt and /salt/roots/pillar respectively. They can
then be commited into Git where you will be confident that anyone who pulls down
the project could build a server capable of hosting the project.

A second option is to store store a system's configuration be stored seperate from
individual projects and instead have support for those projects written into that
configuration. This would optimally be a seperate repository containing both the Salt State
Tree and the Salt Pillar Roots for the production environment. Projects can include this
project in as /salt/roots enabling multiple projects to share an environment.

This article advocates for the second option. By using a seperate repository you seperate
the concerns of operations from the concerns of an individual project. It does require that
you maintain configuration state on an application in two different places. Those places
being 1) the state definitions for hosting the application built inside the configuration
management repository, and 2) the general configuration found inside the specific project's 
repository. However the wins we get from seperating those concerns are huge. One of those
win's being we can use the same set of states to provision both our VMs and our production
machines.


## Building Salt State Tree

With Vagrant primed and ready to go we just need to create a Salt State Tree
that will define how our hosting environment will look. The goal in this
tutorial is to end up with something we could use both with Vagrant on
VirtualBox but also to deploy and provision production servers. To that end
we're going to create a seperate Git repository for storing the Salt File Tree.

First create the directory which will contain this repository.  I keep mine
stored in a generic location as it gets used across projects and servers.

    mkdir -p ~/salt-trees/webapps
    cd ~/salt-trees/webapps
    git init
    wget https://github.com/patmcnally/salt-states-webapps/archive/master.zip
    unzip master.zip
    mv salt-states-webapps-master salt
    mkdir -p pillar

Create pillar/top.sls

    base:
      '*':
        - users

Create pillar/users.sls

    sudoers_users: ['USER']

Copy id_rsa.pub into state tree

    cp ~/.ssh/id_rsa.pub ~/salt-trees/webapps/salt/user/keys/USER_id_rsa.pub

Create application specific state is salt/apps/emperor_norton/init.sls
Create vhost specific state is salt/apps/emperor_norton/vhost.sls
Create vhost host file itself in salt/apps/emperor_norton/emperor_norton.vhost

## Finish Line

    vagrant up

    your project directory is now being served at http://emperor-norton-app.dev

## Deploying in production

## Random pulls

I'm a seasoned Rails junkie so Laravel's MVC flavored PHP hit gets me in all
the right spots.


laravel-master-zip: https://github.com/laravel/laravel/archive/master.zip
compser: compser.com
laravel-docs: http://laravel.com/docs
[laravel-app-repo]: http://github.com/patmcnally/salty-vagrant-laravel-app
[laravel-app-vagrantfile]: http://raw.github.com/patmcnally/salty-vagrant-laravel-app/Vagrantfile
[virtual-box-link]: https://www.virtualbox.org "Oracle VM VirtualBox"
[virtual-box-downloads]: https://www.virtualbox.org/wiki/Downloads "Downloads â€“ Oracle VM VirtualBox"
[vagrant-download]: http://docs.vagrantup.com/v2/installation/ "Vagrant - Installation"
[vagrant-link]: http://vagrantup.com/ "Vagrant"
[salty-vagrant-link]: https://github.com/saltstack/salty-vagrant "Salty Vagrant Plugin"
